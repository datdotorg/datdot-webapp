const style_sheet = require('support-style-sheet')
const make_element = require('make-element')
const make_grid = require('make-grid')
const message_maker = require('message-maker')
const bubble_map = require('components/datdot-ui-bubble-map/src')
const linechart = require('linechart')
const plans_list = require('components/datdot-ui-plans-list/src')

module.exports = i_container
function i_container({page = '*', flow = 'ui-container', name, body = {}}, protocol) {
    const recipients = []
    const make = message_maker(`${name} / ${flow} / ${page}`)
    function widget () {
        const send = protocol(get)
        const el = make_element({name: 'i-container'})
        const shadow = el.attachShadow({mode: 'closed'})
        const map = bubble_map({name: 'counts-map'}, container_protocol('counts-map'))
        const chart = linechart()
        const planslist = plans_list({name: 'plans-list', body: 'aaaa'}, container_protocol('plans-list'))
        // !important style_sheet must be implemented before shadow 
        // For Safari and Firefox cannot implement shadow before style
        style_sheet(shadow, style)
        if (page === 'plans') render_plans([planslist, chart, map], shadow)
        return el

        function render_plans (args, target) {
            return args.forEach( item => target.append(item) )
        }

        function container_protocol (name) {
            return send => {
                recipients[name] = send
                return get
            }
        }
        function get (msg) {
            const {head, type, refs, meta, data} = msg
            const from = head[0].split(' / ')[0]
            const to = head[1]
            send(make(msg))
            // console.log('from container.js', msg)
            console.log(msg)
            if (type.match(/load-page/)) return console.log(data.page)
        }
    }

    const style = `
    :host(i-container) {
        display: grid;
        /* make auto responsive */
        grid-template-rows: repeat(auto-fit, minmax(0, 1fr)); 
        height: 100%;
    }
    @media (max-width: 600px) {
        :host(i-container) {
        }
    }
    `
    return widget()
}
